# Repository Guidelines

## Project Structure & Module Organization
Core services live in `bin/`: `lib/` provides shared helpers, `modules/` contains detectors, and `core/`, `importer/`, `exporter/`, and `trackers/` host the long-running workers. The Flask UI and API live in `var/www/` (`Flask_server.py`, `blueprints/`, `static/`, `templates/`). Default settings and Redis/Kvrocks configs are in `configs/` (`core.cfg.sample`, `modules.cfg`, `63xx.conf`). Tests reference fixtures under `tests/` and `samples/`, while operational tooling is grouped under `tools/`, `other_installers/`, and the top-level maintenance scripts.

## Build, Test, and Development Commands
- `./installing_deps.sh` — installs the OS packages (Redis, Kvrocks, crawler deps).
- `python3 -m venv .venv && .venv/bin/pip install -r requirements.txt` — creates the Python 3.8+ environment used by workers and tests.
- `bin/LAUNCH.sh -l` — boots Redis shards, queues, and the Flask UI; export `AIL_HOME=$PWD` and `AIL_BIN=$PWD/bin` beforehand.
- `./docker_start.sh` — runs the supported container stack for parity with production and CI.
- `./update/Update.py --fetch` — refreshes tracker data and module metadata.

## Coding Style & Naming Conventions
Follow PEP 8 with 4-space indents, snake_case modules in `bin/lib`, and CapWords classes aligned with filenames (`modules/ApiKey.py` → `class ApiKey`). Keep modules message-driven and avoid hard-coded paths—use `ConfigLoader` or env vars like `AIL_HOME`. All runtime logs should use `lib.ail_logger` for consistent formatting. Front-end additions belong in `var/www/templates/<feature>.html` with supporting JS/CSS under `var/www/static/<feature>/`.

## Testing Guidelines
Tests are `unittest` suites executed through `nose2`; many require the fixture copy performed in `tests/test_modules.py`, so ensure `samples/` contains fresh data. Start the stack via `bin/LAUNCH.sh`, set `AIL_HOME` and `AIL_BIN`, then run:
```bash
AIL_HOME=$PWD AIL_BIN=$PWD/bin nose2 -s tests -vv
```
Add fixtures under `samples/<YYYY>/<MM>/<DD>/` and keep gzipped IDs consistent with the assertions.

## Commit & Pull Request Guidelines
Commit subjects in this repo stay short and imperative (`Updated LAUNCH script variables`, `keeping original docker start`). Use prefixes when helpful (`modules:`, `var/www:`) and cite issues with `Fixes #123`. Pull requests should list the problem, the module(s) touched, config or migration steps (especially for files in `configs/`), and verification evidence (test output or UI screenshots from `https://localhost:7000/`).

## Security & Configuration Tips
Do not commit actual API keys; store them in local copies of `configs/*.sample` or `configs/keys/` with `chmod 600`. Remove the autogenerated `DEFAULT_PASSWORD` after first login, because some installers check for its absence. Redact PII, Tor addresses, and tokens before sharing anything from `logs/` or `var/www/static/`. Consult `SECURITY.md` whenever adding importers/exporters that touch external services.
